/* =============================================================================
   Test GetKeyMatrix from Keyboard MSX-ROM Library (fR3eL Project)
   Version: 1.3 (30/11/2023)
   Author: mvac7/303bcn [mvac7303b@gmail.com]
   Architecture: MSX
   Format: C object (SDCC .rel)
   Programming language: C and Z80 assembler
   Compiler: SDCC 4.1.12 or newer 

   Description:
     Test the GetKeyMatrix function of the MSXROM Keyboard library.
     
   History of versions:
   - v1.3 (30/11/2023) update to SDCC (4.3) and Keyboard MSX-ROM v1.1 library 
   - v1.2 (18/06/2019) improved pulsation control
   - v1.1 (24/06/2018)
   - v1.0 (06/02/2016)
     
============================================================================= */

#include "../include/newTypes.h"
#include "../include/msxSystemVariables.h"
#include "../include/msxBIOS.h"

#include "../include/keyboard_MSX.h"



#define  HALT __asm halt __endasm   //Z80 instruction > wait for the next interrupt


// VRAM address tables screen 0 TXT40
#define BASE0 0x0000 // base 0 name table
#define BASE2 0x0800 // base 2 character pattern table



// Function Declarations -------------------------------------------------------
void test(void);

void printKey(char column, char line);

void PRINT(char column, char line, char* text);
uint GetVAddressByPosition(char column, char line);

char PEEK(uint address);

void SCREEN0(void);
void VPOKE(char value, unsigned int vaddr);
char VPEEK(unsigned int vaddr);
void CopyToVRAM(unsigned int addr, unsigned int vaddr, unsigned int length);



// constants  ------------------------------------------------------------------
const char text01[] = "Test Keyboard MSXROM Lib";
const char text02[] = "Test GetKeyMatrix()";



// TEST Apps
// map size width:40 height:24
// Size= 960
const unsigned char keyb_map[]={
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x37,0x20,0x20,0x20,0x36,0x20,0x20,0x20,0x35,0x20,0x20,
0x20,0x34,0x20,0x20,0x20,0x33,0x20,0x20,0x20,0x32,0x20,0x20,0x20,0x31,0x20,0x20,
0x20,0x30,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x18,0x17,0x17,0x17,0x12,
0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,
0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x19,0x20,0x20,0x20,0x20,
0x20,0x20,0x30,0x16,0x20,0x37,0x20,0x16,0x20,0x36,0x20,0x16,0x20,0x35,0x20,0x16,
0x20,0x34,0x20,0x16,0x20,0x33,0x20,0x16,0x20,0x32,0x20,0x16,0x20,0x31,0x20,0x16,
0x20,0x30,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x31,0x16,0x20,0x3B,0x20,0x16,0x20,0x5D,0x20,0x16,0x20,0x5B,0x20,0x16,
0x20,0x5C,0x20,0x16,0x20,0x3D,0x20,0x16,0x20,0x2D,0x20,0x16,0x20,0x39,0x20,0x16,
0x20,0x38,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x32,0x16,0x20,0x42,0x20,0x16,0x20,0x41,0x20,0x16,0x41,0x63,0x4F,0x16,
0x20,0x2F,0x20,0x16,0x20,0x2E,0x20,0x16,0x20,0x2C,0x20,0x16,0x41,0x63,0x43,0x16,
0x20,0x27,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x33,0x16,0x20,0x4A,0x20,0x16,0x20,0x49,0x20,0x16,0x20,0x48,0x20,0x16,
0x20,0x47,0x20,0x16,0x20,0x46,0x20,0x16,0x20,0x45,0x20,0x16,0x20,0x44,0x20,0x16,
0x20,0x43,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x34,0x16,0x20,0x52,0x20,0x16,0x20,0x51,0x20,0x16,0x20,0x50,0x20,0x16,
0x20,0x4F,0x20,0x16,0x20,0x4E,0x20,0x16,0x20,0x4D,0x20,0x16,0x20,0x4C,0x20,0x16,
0x20,0x4B,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x35,0x16,0x20,0x5A,0x20,0x16,0x20,0x59,0x20,0x16,0x20,0x58,0x20,0x16,
0x20,0x57,0x20,0x16,0x20,0x56,0x20,0x16,0x20,0x55,0x20,0x16,0x20,0x54,0x20,0x16,
0x20,0x53,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x36,0x16,0x46,0x33,0x20,0x16,0x46,0x32,0x20,0x16,0x46,0x31,0x20,0x16,
0x43,0x4F,0x44,0x16,0x43,0x41,0x50,0x16,0x47,0x52,0x41,0x16,0x43,0x54,0x52,0x16,
0x53,0x48,0x49,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x37,0x16,0x52,0x45,0x54,0x16,0x53,0x45,0x4C,0x16,0x42,0x53,0x20,0x16,
0x53,0x54,0x4F,0x16,0x54,0x41,0x42,0x16,0x45,0x53,0x43,0x16,0x46,0x35,0x20,0x16,
0x46,0x34,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x38,0x16,0x52,0x49,0x47,0x16,0x44,0x4F,0x57,0x16,0x55,0x50,0x20,0x16,
0x4C,0x45,0x46,0x16,0x44,0x45,0x4C,0x16,0x49,0x4E,0x53,0x16,0x48,0x4F,0x4D,0x16,
0x53,0x50,0x41,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x1A,0x17,0x17,0x17,0x11,
0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,
0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x1B,0x20,0x20,0x20,0x20};


// global variable definition --------------------------------------------------



// Functions -------------------------------------------------------------------


//
void main(void)
{
//  COLOR(LIGHT_GREEN,DARK_GREEN,DARK_GREEN);    
  SCREEN0();
    
  test();

}



/* -----------------------------------------------------------------------------

----------------------------------------------------------------------------- */
void test(void)
{
  char val;
  char keyPressed;
  char row;
  uint i;
  uint offset;
  uint vaddr = BASE2 + (32*8);
 
  CopyToVRAM((uint) keyb_map,BASE0,0x3c0);
  
  PRINT(0,0,text01);
  PRINT(0,1,text02);
  
  
  // genera una copia de los caracteres en la posicion 128 en negativo
  for (i=0;i<768;i++)
  {
    val = ~ VPEEK(vaddr); //invierte el valor
    VPOKE(val,vaddr+768); //lo copia en un tile superior
    vaddr++;              // avanza a la siguiente posicion de la vram
  }

  


  while(1)  //infinite loop
  {
    HALT;

    for(row=0;row<9;row++)
    {
      keyPressed = GetKeyMatrix(row);
      
      if (keyPressed==255)
      {
        //no se han pulsado teclas de esta linea 
        offset = 244+(row*80);
        CopyToVRAM((uint) keyb_map + offset, BASE0 + offset, 31);
      }else{
        if (!(keyPressed&Bit0)) printKey(7,row); 
        if (!(keyPressed&Bit1)) printKey(6,row);
        if (!(keyPressed&Bit2)) printKey(5,row);
        if (!(keyPressed&Bit3)) printKey(4,row);
        if (!(keyPressed&Bit4)) printKey(3,row);
        if (!(keyPressed&Bit5)) printKey(2,row);
        if (!(keyPressed&Bit6)) printKey(1,row);
        if (!(keyPressed&Bit7)) printKey(0,row); 
      }
    
    } //END For
  } //END while
    
  
}



/* -----------------------------------------------------------------------------

----------------------------------------------------------------------------- */
void printKey(char column, char line)
{ 
  char tmpTile;
  uint vaddr;
  uint addr;
  
  vaddr = 244 + (column*4) +(line*80);
  addr= (uint) keyb_map + vaddr;
  
  tmpTile = PEEK(addr++);
  VPOKE(tmpTile+96,vaddr++);
    
  tmpTile = PEEK(addr++);
  VPOKE(tmpTile+96,vaddr++);
    
  tmpTile = PEEK(addr);
  VPOKE(tmpTile+96,vaddr);

}



/* =============================================================================
 muestra un texto en la pantalla de varias lineas separadas 
 con el codigo de escape newline \n
 ejem: PRINT(0,10,"ARE YOU SURE\nYOU WANT TO\nDELETE SONG?");
============================================================================= */
void PRINT(char column, char line, char* text)
{
  char character;
  uint vaddr = GetVAddressByPosition(column, line);  

  while(*(text))
  {
    character=*(text++);
    VPOKE(character,vaddr++);
  }
}



/* =============================================================================
 It provides the address of the video memory map tiles, from the screen position
 indicated.
 Proporciona la direccion de la memoria de video del mapa de tiles, a partir de
 la posicion de pantalla indicada.
 Inputs:
   column (char) 0 - 39
   line (char) 0 - 23
============================================================================= */
uint GetVAddressByPosition(char column, char line)
{
   return BASE0 + (line*40)+column; //<------ BASE0 for screen 0; use BASE5 for screen 1 
}



char PEEK(uint address) __naked
{
address; //HL
__asm

  ld   A,(HL)

  ret
__endasm;
}



/* =============================================================================
 SCREEN0
 
 Description: 
			Initialice TEXT 1 (40 columns) or TEXT 2 (80 columns) screen mode.
		   
 Input:    -
 Output:   -
============================================================================= */
void SCREEN0(void) __naked
{
__asm
 
  ld   A,(#LINLEN)
  ld   (#LINL40),A   ;copy columns seting with WIDTH to LINL40 system var
  
  jp   BIOS_INITXT

__endasm;
}



/* =============================================================================
 VPOKE
 Description: Writes a byte to the video RAM. 
 Input      : [char] value
              [unsigned int] VRAM address
              
 Output     : - 
============================================================================= */
void VPOKE(char value, unsigned int vaddr) __naked
{
value; //A
vaddr; //DE
__asm
  ex   DE,HL
  jp   BIOS_WRTVRM
__endasm;
}



/* =============================================================================
 VPEEK
 Description: Reads data from the video RAM. 
 Input      : [unsigned int] VRAM address
 Output     : [char] value
============================================================================= */ 
char VPEEK(unsigned int vaddr) __naked
{
vaddr;
__asm
  jp BIOS_RDVRM
__endasm;
}



/* =============================================================================
 CopyToVRAM
 Description: Block transfer from memory to VRAM 
 Input      : [unsigned int] address of RAM
              [unsigned int] address of VRAM
              [unsigned int] blocklength
 Output     : - 
============================================================================= */
void CopyToVRAM(unsigned int addr, unsigned int vaddr, unsigned int length)
{
addr;	//HL
vaddr;	//DE
length;	//Stack
__asm
  push IX
  ld   IX,#0
  add  IX,SP 

  ld   C,4(IX) ;length
  ld   B,5(IX)
  
  call BIOS_LDIRVM
  
  pop  IX
__endasm;
}
